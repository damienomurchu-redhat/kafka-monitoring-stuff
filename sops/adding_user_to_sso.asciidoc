// begin header
ifdef::env-github[]
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
endif::[]
:numbered:
:toc: macro
:toc-title: pass:[<b>Table of Contents</b>]
// end header
= Creating users in MAS-SSO for Data Plane OSD clusters

toc::[]

== Description

The purpose of this SOP is to describe the process of creating users in MAS-SSO for Data Plane OSD cluster access. 


== Prerequisites

You will need access to the following:

* A member of the RTS Team
* Rhoas-kafka-sre realm in MAS-SSO
** https://keycloak-mas-sso-stage.apps.app-sre-stage-0.k3s7.p1.openshiftapps.com/auth/admin/rhoas-kafka-sre/console/#/realms/rhoas-kafka-sre/users[Stage]
** https://identity.api.openshift.com/auth/admin/rhoas-kafka-sre/console/#/realms/rhoas-kafka-sre/users[Prod]
* OCM credentials to login as the creator of the data plane cluster which can be found in vault https://vault.devshift.net/ui/vault/secrets/app-interface/show/managed-service-api/production/service/credentials[prod] https://vault.devshift.net/ui/vault/secrets/app-interface/show/managed-service-api/stage/service/credentials[stage]


== Execute/Resolution
=== Creating the user in SSO
[NOTE] 
Steps 1-5 need to be done by a member of the RTS team

1. Login into MAS SSO using your credentials Username:`kerberos`
2. Navigate to the Rhoas-kafka-sre realm and then to users in the side bar on the left.
3. Create the new user by clicking on the add user button on the right-hand side
4. Give the user a user name and any other information you want to add. Make sure the user enabled slider is set to on.

image::images/add_user.png[]
[start=5]
5. Once you click save you will be able to give the user credentials. This is done by clicking the credentials tab and either giving them a temporary password which the user changes when they first login or a permanent password that can't be changed.

image::images/add_creds.png[]


=== Giving the user permission in OSD data plane cluster
1. To give the users permissions you will need ocm permissions to login as the service account that created the data plane 
* Prod: `ocm login --url=https://api.openshift.com --client-id=<client-id> --client-secret=<client-secret>` 
* Stage: `ocm login --url=https://api.stage.openshift.com --client-id=<client-id> --client-secret=<client-secret>`
2. Add or remove a user in the user.yaml file 
3. `chmod +x permissions.sh`
4. `./ permissions.sh -a`

== Validate

1. Check that the users have been created using the ocm get command from the SOP doc.

2. Make sure the users can log in to the data plane cluster using the kafka_sre idp option

[start=3]
3. Ensure they have the relevant permissions in the cluster by checking the groups in the user management tab of the cluster


== Troubleshooting

If people are unable to login ensure the username specified in sso is the same as the one your giving permissions to in user.json
