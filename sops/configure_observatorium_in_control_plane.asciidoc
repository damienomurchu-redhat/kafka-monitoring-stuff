// begin header
ifdef::env-github[]
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
endif::[]
:numbered:
:toc: macro
:toc-title: pass:[<b>Table of Contents</b>]
// end header
= Configure Observatorium credentials in the Control Plane

toc::[]

== Description

This SOP describes how to update credentials and configuration for the Observatorium instance the Control Plane (and indirectly, the Data Plane) should use.

== Prerequisites

1. Access to the vault secret where Observatoriums credentials are stored https://vault.devshift.net/ui/vault/secrets/app-interface/show/managed-service-api/production/service/credentials
2. Ability to create merge requests against https://gitlab.cee.redhat.com/service/app-interface

== Execute/Resolution

=== Update observability config

1. Create a PR with your changes against the `main` branch of https://github.com/bf2fc6cc711aee1a0c2a/observability-resources-mk
2. When merged, rebase the `prod` branch on `main`. Make sure that the Observatorium config on the `prod` branch is *not* updated.
3. Create a tag named `v1.x.y-staging` from `main`. Replace `x` and `y` with the actual minor and patch versions.
4. Create a tag named `v1.x.y-prod` from `prod`. Replace `x` and `y` with the actual minor and patch versions.

=== Update service provision templates

1. Create a merge request with updated values for the relevant parameters in https://gitlab.cee.redhat.com/service/app-interface/-/blob/master/data/services/managed-services/cicd/saas/saas-kas-fleet-manager.yaml
Known paramaters are DEX_URL, DEX_USERNAME, OBSERVATORIUM_GATEWAY, OBSERVATORIUM_TENANT, OBSERVABILITY_CONFIG_REPO, OBSERVABILITY_CONFIG_TAG and OBSERVABILITY_CONFIG_CHANNEL. Make sure that `OBSERVABILITY_CONFIG_TAG` matches the tags created in the previous steps. `OBSERVABILITY_CONFIG_CHANNEL` should *always* be `resources`.
+
NOTE: There are two distinct templates, one for configuring production environments and one for staging. You can find then by searching in the file for `environment: prod` or `environment: stage`.
2. Update secret values in vault if needed https://vault.devshift.net/ui/vault/secrets/app-interface/show/managed-service-api/production/service/credentials Relevant secrets include `dex.secret`, `dex.password` and `observatorium.token`
3. Update the version in https://gitlab.cee.redhat.com/service/app-interface/-/blob/master/data/services/managed-services/namespaces/managed-services-production.yml#L40 to match the vault secret version and create a new merge request.
4. Get the merge requests reviewed & merged

== Validate

1. Verify the values in the control plane are correct by comparing to the secrets in the control plane cluster. TODO
2. Verify data is being sent to Observatorium. TODO

== Troubleshooting

TODO